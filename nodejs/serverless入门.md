# serverless 入门

time: 2020.12.31  
author: heyunjiang

## 1 背景

今天开始学习 serverless 相关知识，基于以下原因  
1. 学习 nodejs 后端，结合具体方向使用相关技术，了解软件全流程
2. 团队有相关业务，学习 + 实战

## 2 基础知识

1. serverless 就是一套工具，减少运维成本，扩展前端技术层面，激发前端创造力，前端工程师可以做完整应用
2. 狭义 serverless：Faas + Baas
3. 广义 serverless：任何不需要运维或弱运维的服务
3. 由 BFF => SFF

## 3 Faas

1. 接受 http 请求
2. 结构：触发器 + 函数服务 + 函数代码
3. 运行环境：整体运行在容器中，内部提供了 runtime，比如 os、硬件信息、环境变量、nodejs 环境、三方依赖、代码
4. 进程类型：常驻内存型 + 用完即毁型
5. 括缩容：一版指横向括缩容，增加机子台数
6. 冷启动流程：系统资源调度、下载函数代码、启动容器、启动 runtime、函数初始化、函数执行
7. cass: container as a service，指的是容器服务
8. docker 与 vm 不同：docker 基于同一进程，是在不同线程级别操作，共享内存，优点是轻量、启动速度更快(启动一个进程，而非os)、代码执行速度更快。可以将 docker 部署在任何 docker 引擎上
9. 容器括缩容：监听容器指标 cpu 利用率、内存使用率、硬盘使用率、网络链接数等，某一指标超出预估水位，则需要扩容，低于水位，则缩容，也称 `弹性服务`

> 云服务发展历史：裸机房、vm 虚拟机、Iaas、Paas、Baas、Caas、ServerLess  

优点：  
1. 不使用时缩容到0
2. 使用时可以极速冷启动，因为只需要启动容器 + 前端运行时，其他服务由 Baas 层提供

## 4 Baas

1. 后端 Baas 化包含：数据库、dns、网关、中间件、日志等
2. 微服务调用：RPC
3. Serverless Baas 服务调用：HTTP
4. 微服务10要素：`API、服务调用、服务发现；日志、链路追踪；容灾、监控、括缩容；发布管道；鉴权`
5. 领域驱动 DDD：通过对业务分层抽象，分析定义出领域模型，用领域模型驱动设计系统，将复杂的业务模型拆分为独立运维的领域模型
6. 动态网络节点：后端各 Baas 节点是动态的，分分合合。优化目的是减少核心节点、保护核心节点、降低网络调用链深度
7. 服务编排：服务节点合并，是操作动态网络节点的一种高级说法
8. JWT：通过统一鉴权服务，生成 JWT 字符串，也就是数字签名，预签名，每次 http 请求都带上
9. 发布：发布管道，发布流水线，cicd，灰度

## 5 k8s

1. 原名 kubernetes，用于自动部署、扩展和管理容器化应用程序的开源系统，不限制使用 docker
2. 使用 `kubectl` cli 管理 k8s
3. 容器镜像服务：属于一个仓库平台，阿里有提供私有镜像服务，类似于 npm 仓库。而本地可以制作个人镜像，发布到镜像仓库中，类似于 npm 发布
4. 云原生：一套通用的云服务商解决方案，用以解决受单一云服务商限制的解决方案，让用户可以自己选择某一个服务对应的云服务商。而 k8s 就是云原生的核心
5. k8s集群：由 master 节点 + worker 节点组成
6. k8s集群 - master: master 节点由 api server、kube-controller-manager、etcd 等组成，负责维护集群状态，管理 worker 节点，保证职责单一，不会运行容器实例
7. k8s集群 - worker：也就是 k8s node 节点，每个 k8s 集群包含多个 worker 节点，每个节点内部包含多个 pod，pod 是容器运行的最小单位，它包含了一个集群 ip；一个 pod 可以运行一个或多个容器实例，会共享 pod 端口，一般只运行一个容器
8. k8s集群 - 集群网络：每个 k8s 集群构建自己的网络，内部每个 pod 由自己的 ip，集群内部互通；跨集群通信需要暴露服务，通过 http 访问

## 参考文章

[kubectl - k8s 管理工具](https://kubernetes.io/zh/docs/tasks/tools/install-kubectl/)  
[serverless 指南](http://serverless.ink/)
