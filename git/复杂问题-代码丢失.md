# 复杂问题-代码丢失

time: 2020.6.12  
author: heyunjiang

## 1 背景描述

代码丢失问题。刚上线1天的功能，代码也合并到 master 上了，后来同组小伙伴发布新功能，新功能上线后，我的功能不见了，代码也丢失了。

团队规模：8个前端  
业务模式：大迭代 + 多敏捷迭代 + 多 hotfix + 多其他杂项业务(总之就是每个人手里很多分支，随时都可能向 master 合并代码)  
迭代丢失模式：在主 master git log 都还存在记录，但是最近 head 指针丢失相应代码，丢失代码区间在 log 中间，后面还有一些其他伙伴提交记录

## 2 问题分析

在

## 3 解决思路

1. git diff commita commitb：找到从 a 到 b 之后，有哪些文件变化

## 4 问题总结

1. 确定代码丢失 commit 节点丢失阶段：在 master 分支 `git log --graph` ，明确知道自己修改哪部分代码，在哪个节点丢失了代码
2. 明确知道自己丢失的哪些代码：个人日常 commit 规范，功能单一，无副作用，通过 `git cherry-pick <commitid>` 拿到需要的代码，作为新的 commit 内容
3. 代码丢失：多是 merge 时，当前分支解决冲突时，没有选择目标分支的代码，导致当前分支文档内容不包含目标分支内容，所以也就没有文件 git 对应增删记录。

> merge 操作，是基于2分支公共节点，将目标分支代码合并到当前分支。  
> 如果没有冲突，执行快速合并，将 head 指针指向最新 commit；  
> 如果有冲突，则会列出目标分支所有改动点，没有冲突的则放入暂存区，有冲突的放入工作区，待开发者解决冲突。解决冲突之后，会产生一个新的 commit 节点，表示合并代码记录，当前分支而不会保留目标分支的 commit 记录。

问题归纳：  
1. 还是团队 git 操作不规范，或者成员操作不规范造成的，需要团队规范化 git 操作

## 5 解决问题方案总结

总结一下，解决代码丢失解决套路

1. 查找主干分支代码丢失 commit 区间，找到 commita, commitb
2. 命令解决：如果当前主干分支之后没有新的提交 commit，或者很少(不影响回滚)，可以通过 reset 到指定正常 commit 节点 (或者基于此 commit 新拉一个分支)，重新执行一次 merge 操作
3. 代码覆盖解决：如果当前主干分支没有办法直接回滚，那么只有重新覆盖已有的代码，这里分为明确知道自己丢失了哪些代码，不清楚哪些代码丢失。

明确知道丢失代码：在主干分支重新 `git cherry-pick` 拉取开发分支对应的多个 commit 节点，作为主干分支的新提交 commit 内容。

> 如果想确定修改内容是否正确，可以通过 `git reset --mixed <commitid>` 命令，将拉过来的 commit 从暂存区拉出到工作区，然后 diff 查看每个文件变更

如果不明确知道自己哪些代码丢失：直接对比找到的丢失 commit 区间，`git diff commita commitb` 找到他们的内容差别，也可以直接输出文件 `--output=hello`。列出差别之后，可以从差异内容中，找到你丢失的内容信息，copy 重写一次。

## 参考文章

[git 标准在线文档](https://git-scm.com/docs/git-reset#Documentation/git-reset.txt-emgitresetemltmodegtltcommitgt)
